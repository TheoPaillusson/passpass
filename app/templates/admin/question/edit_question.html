{% extends "admin/layout.html" %}
{% block title %}Edit Question{% endblock %}

{% block content %}
<h2>Editer la Question {{ question.id }}</h2>
<form method="POST" enctype="multipart/form-data">
    {{ form.hidden_tag() }}

    <div>
        {{ form.question_statement.label }}
        {{ form.question_statement() }}
        {{ form.question_image.label }}
        {{ form.question_image() }}

        {% if question.image_filename %}
        <div class="mb-3">
            <label class="form-label">Image actuelle :</label>
            <div class="question-image-wrapper">
                <img src="{{ url_for('static', filename='uploads/questions/' + question.image_filename) }}"
                     alt="Image actuelle" class="img-fluid rounded shadow">
            </div>
        </div>
        {% endif %}
    </div>

    {% for field in [form.option1, form.option2, form.option3, form.option4, form.option5, form.correct_options] %}
        <div>
            {{ field.label }}
            {{ field() }}
            {% if field.errors %}
                <ul class="errors">
                    {% for error in field.errors %}<li>{{ error }}</li>{% endfor %}
                </ul>
            {% endif %}
        </div>
    {% endfor %}

    <h3>Sous-questions</h3>
    <div id="sub-questions">
        {% for subform in form.sub_questions %}
            {% set subform = subform %}
            {% include "admin/question/sub_question_block.html" %}
        {% endfor %}
    </div>
    <button type="button" id="add-sub-question" class="btn btn-secondary">Ajouter une sous-question</button>

    {% set subform = empty_sub_form %}
    <template id="empty-sub-question-template">
        {% include "admin/question/sub_question_block.html" %}
    </template>

    <div class="mt-4">
        {{ form.submit() }}
    </div>
</form>

<script>
    // Ajouter une sous-question dynamiquement
    document.getElementById("add-sub-question").addEventListener("click", function () {
        const container = document.getElementById("sub-questions");
        const index = container.children.length;
        const template = document.getElementById("empty-sub-question-template").innerHTML;
        const tempDiv = document.createElement("div");
        // Remplacer le placeholder __prefix__ par l'index
        tempDiv.innerHTML = template.replace(/sub_questions-__prefix__/g, `sub_questions-${index}`);
        container.appendChild(tempDiv.firstElementChild);
    });

    // Suppression d'une sous-question
    document.addEventListener("click", function (e) {
        if (e.target && e.target.classList.contains("remove-sub-question")) {
            e.target.closest(".sub-question-block").remove();
        }
    });
</script>
{% endblock %}
